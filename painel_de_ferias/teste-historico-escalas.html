<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Hist√≥rico de Escalas</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
        }
        .form-group { 
            margin-bottom: 15px; 
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
        }
        input, select { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        button { 
            background: #007bff; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            margin-right: 10px;
        }
        .escala-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .escala-ativa {
            border-left: 4px solid #28a745;
        }
        .escala-inativa {
            border-left: 4px solid #dc3545;
            opacity: 0.7;
        }
        .message { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste - Hist√≥rico de Escalas</h1>
        
        <div id="message"></div>
        
        <div class="form-group">
            <label for="funcionario-select">Selecionar Funcion√°rio:</label>
            <select id="funcionario-select">
                <option value="">Carregando funcion√°rios...</option>
            </select>
        </div>
        
        <div style="margin: 20px 0;">
            <button onclick="cadastrarEscalaTeste()">Cadastrar Escala de Teste</button>
            <button onclick="carregarHistorico()">Carregar Hist√≥rico</button>
            <button onclick="listarTodasEscalas()">Listar Todas as Escalas</button>
            <button onclick="testarAPI()">Testar API</button>
        </div>
        
        <div id="debug-info" class="debug-info"></div>
        
        <h3>üìä Hist√≥rico de Escalas</h3>
        <div id="escalas-container">
            <p>Selecione um funcion√°rio e clique em "Carregar Hist√≥rico"</p>
        </div>
        
        <h3>üìã Todas as Escalas</h3>
        <div id="todas-escalas-container">
            <p>Clique em "Listar Todas as Escalas" para ver</p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let funcionarios = [];
        let funcionarioSelecionado = null;
        
        function showMessage(message, type) {
            const messageEl = document.getElementById('message');
            messageEl.className = `message ${type}`;
            messageEl.textContent = message;
        }
        
        function showDebugInfo(info) {
            document.getElementById('debug-info').textContent = JSON.stringify(info, null, 2);
        }
        
        function formatDateBR(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        // Carregar funcion√°rios
        async function carregarFuncionarios() {
            try {
                const response = await fetch(`${API_BASE}/funcionarios`);
                if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                
                funcionarios = await response.json();
                
                const select = document.getElementById('funcionario-select');
                select.innerHTML = '<option value="">Selecione um funcion√°rio</option>';
                
                funcionarios.forEach(func => {
                    const option = document.createElement('option');
                    option.value = func.id;
                    option.textContent = `${func.id} - ${func.nome}`;
                    select.appendChild(option);
                });
                
                showMessage(`${funcionarios.length} funcion√°rios carregados!`, 'success');
                
            } catch (error) {
                showMessage(`Erro ao carregar funcion√°rios: ${error.message}`, 'error');
                showDebugInfo({ error: error.message });
            }
        }
        
        // Testar conex√£o com API
        async function testarAPI() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                
                const status = await response.json();
                showDebugInfo(status);
                showMessage('‚úÖ API funcionando corretamente!', 'success');
                
            } catch (error) {
                showMessage(`‚ùå Erro na API: ${error.message}`, 'error');
                showDebugInfo({ error: error.message });
            }
        }
        
        // Cadastrar escala de teste
        async function cadastrarEscalaTeste() {
            const select = document.getElementById('funcionario-select');
            const funcionarioId = parseInt(select.value);
            
            if (!funcionarioId) {
                showMessage('Selecione um funcion√°rio primeiro', 'error');
                return;
            }
            
            // Datas de teste (hoje + 14 dias)
            const hoje = new Date();
            const embarque = new Date(hoje);
            embarque.setDate(hoje.getDate() + 1); // Amanh√£
            
            const desembarque = new Date(embarque);
            desembarque.setDate(embarque.getDate() + 13); // 14 dias de trabalho
            
            const dadosEscala = {
                funcionarioId,
                dataEmbarque: embarque.toISOString().split('T')[0],
                dataDesembarque: desembarque.toISOString().split('T')[0]
            };
            
            try {
                showMessage('Cadastrando escala de teste...', 'success');
                showDebugInfo({ message: 'Enviando dados', dados: dadosEscala });
                
                const response = await fetch(`${API_BASE}/escalas`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dadosEscala)
                });
                
                const resultado = await response.json();
                
                if (!response.ok) {
                    throw new Error(resultado.erro || `Erro HTTP: ${response.status}`);
                }
                
                showMessage('‚úÖ Escala cadastrada com sucesso!', 'success');
                showDebugInfo({ message: 'Escala criada', resultado });
                
                // Recarregar hist√≥rico automaticamente
                if (funcionarioSelecionado && funcionarioSelecionado.id === funcionarioId) {
                    setTimeout(carregarHistorico, 1000);
                }
                
            } catch (error) {
                showMessage(`‚ùå Erro ao cadastrar escala: ${error.message}`, 'error');
                showDebugInfo({ error: error.message });
            }
        }
        
        // Carregar hist√≥rico de escalas do funcion√°rio selecionado
        async function carregarHistorico() {
            const select = document.getElementById('funcionario-select');
            const funcionarioId = parseInt(select.value);
            
            if (!funcionarioId) {
                showMessage('Selecione um funcion√°rio primeiro', 'error');
                return;
            }
            
            funcionarioSelecionado = funcionarios.find(f => f.id === funcionarioId);
            
            try {
                showMessage('Carregando hist√≥rico de escalas...', 'success');
                
                // URL corrigida
                const url = `${API_BASE}/escalas/funcionario/${funcionarioId}`;
                showDebugInfo({ message: 'Fazendo requisi√ß√£o para', url });
                
                const response = await fetch(url);
                
                showDebugInfo({ 
                    message: 'Resposta recebida',
                    status: response.status,
                    ok: response.ok,
                    url
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const escalas = await response.json();
                
                showDebugInfo({ 
                    message: 'Escalas carregadas',
                    quantidade: escalas.length,
                    escalas
                });
                
                renderizarEscalas(escalas);
                showMessage(`‚úÖ ${escalas.length} escalas carregadas para ${funcionarioSelecionado.nome}!`, 'success');
                
            } catch (error) {
                showMessage(`‚ùå Erro ao carregar hist√≥rico: ${error.message}`, 'error');
                showDebugInfo({ error: error.message });
                document.getElementById('escalas-container').innerHTML = 
                    `<div class="error">Erro ao carregar escalas: ${error.message}</div>`;
            }
        }
        
        // Renderizar escalas na interface
        function renderizarEscalas(escalas) {
            const container = document.getElementById('escalas-container');
            
            if (escalas.length === 0) {
                container.innerHTML = '<p>Nenhuma escala encontrada para este funcion√°rio.</p>';
                return;
            }
            
            let html = '';
            escalas.forEach(escala => {
                const status = escala.ativo ? 'Ativa' : 'Inativa';
                const cssClass = escala.ativo ? 'escala-ativa' : 'escala-inativa';
                
                html += `
                    <div class="escala-item ${cssClass}">
                        <strong>ID:</strong> ${escala.id} | 
                        <strong>Status:</strong> ${status}<br>
                        <strong>Embarque:</strong> ${formatDateBR(new Date(escala.dataEmbarque))} | 
                        <strong>Desembarque:</strong> ${formatDateBR(new Date(escala.dataDesembarque))}<br>
                        <strong>Funcion√°rio:</strong> ${escala.funcionarioNome || funcionarioSelecionado.nome}<br>
                        <strong>Cadastro:</strong> ${formatDateBR(new Date(escala.dataCadastro))}
                        ${escala.renovacaoAutomatica ? ' | üîÑ Renova√ß√£o Autom√°tica' : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Listar todas as escalas
        async function listarTodasEscalas() {
            try {
                showMessage('Carregando todas as escalas...', 'success');
                
                const response = await fetch(`${API_BASE}/escalas`);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const todasEscalas = await response.json();
                
                showDebugInfo({ 
                    message: 'Todas as escalas',
                    quantidade: todasEscalas.length,
                    escalas: todasEscalas
                });
                
                const container = document.getElementById('todas-escalas-container');
                
                if (todasEscalas.length === 0) {
                    container.innerHTML = '<p>Nenhuma escala encontrada no sistema.</p>';
                    return;
                }
                
                let html = '';
                todasEscalas.forEach(escala => {
                    const status = escala.ativo ? 'Ativa' : 'Inativa';
                    const cssClass = escala.ativo ? 'escala-ativa' : 'escala-inativa';
                    
                    html += `
                        <div class="escala-item ${cssClass}">
                            <strong>ID:</strong> ${escala.id} | 
                            <strong>Status:</strong> ${status}<br>
                            <strong>Funcion√°rio:</strong> ${escala.funcionarioNome} (ID: ${escala.funcionarioId})<br>
                            <strong>Embarque:</strong> ${formatDateBR(new Date(escala.dataEmbarque))} | 
                            <strong>Desembarque:</strong> ${formatDateBR(new Date(escala.dataDesembarque))}<br>
                            <strong>Cadastro:</strong> ${formatDateBR(new Date(escala.dataCadastro))}
                            ${escala.renovacaoAutomatica ? ' | üîÑ Renova√ß√£o Autom√°tica' : ''}
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                showMessage(`‚úÖ ${todasEscalas.length} escalas encontradas no sistema!`, 'success');
                
            } catch (error) {
                showMessage(`‚ùå Erro ao listar todas as escalas: ${error.message}`, 'error');
                showDebugInfo({ error: error.message });
            }
        }
        
        // Event listener para sele√ß√£o de funcion√°rio
        document.getElementById('funcionario-select').addEventListener('change', (e) => {
            const funcionarioId = parseInt(e.target.value);
            funcionarioSelecionado = funcionarios.find(f => f.id === funcionarioId);
            
            if (funcionarioSelecionado) {
                showMessage(`Funcion√°rio selecionado: ${funcionarioSelecionado.nome}`, 'success');
            }
        });
        
        // Carregar dados iniciais
        window.addEventListener('load', () => {
            testarAPI();
            carregarFuncionarios();
        });
    </script>
</body>
</html>
